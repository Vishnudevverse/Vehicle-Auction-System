{% extends "base.html" %}
{% block title %}Live Auctions — AutoBid{% endblock %}

{% block content %}
<!-- ── Hero Section ────────────────────────── -->
<section class="hero-section text-center py-5">
    <div class="container">
        <h1 class="display-4 fw-bold mb-3">
            <i class="bi bi-lightning-charge-fill text-warning me-2"></i>Live Vehicle Auctions
        </h1>
        <p class="lead text-body-secondary mb-4">
            Bid on premium vehicles in real-time. Find your dream car today.
        </p>
        <div class="d-flex justify-content-center gap-3 flex-wrap">
            <span class="badge bg-success-subtle text-success-emphasis fs-6 px-3 py-2">
                <i class="bi bi-broadcast me-1"></i><span id="activeCount">{{ vehicles|length }}</span> Active Auctions
            </span>
            <span class="badge bg-info-subtle text-info-emphasis fs-6 px-3 py-2">
                <i class="bi bi-shield-check me-1"></i>Verified Vehicles
            </span>
            <span class="badge bg-warning-subtle text-warning-emphasis fs-6 px-3 py-2" id="wsStatus">
                <i class="bi bi-wifi-off me-1"></i>Connecting…
            </span>
        </div>
    </div>
</section>

<!-- ── Vehicle Cards ──────────────────────── -->
<section class="py-5">
    <div class="container">
        <div class="row g-4" id="vehicleGrid">
            {% for v in vehicles %}
            <div class="col-lg-4 col-md-6 vehicle-col" data-vehicle-id="{{ v.id }}">
                <div class="card vehicle-card h-100 border-0 shadow-sm">
                    <!-- Image -->
                    <div class="card-img-wrapper position-relative overflow-hidden">
                        {% if v.image_url %}
                        <img src="{{ v.image_url }}"
                             class="card-img-top vehicle-img"
                             alt="{{ v.title }}" loading="lazy" />
                        {% else %}
                        <div class="card-img-top vehicle-img d-flex align-items-center justify-content-center bg-body-secondary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" fill="currentColor"
                                 class="text-body-tertiary" viewBox="0 0 16 16">
                                <path d="M2.5 6a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h11a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-11ZM1 6.5A1.5 1.5 0 0 1 2.5 5h11A1.5 1.5 0 0 1 15 6.5v3A1.5 1.5 0 0 1 13.5 11h-11A1.5 1.5 0 0 1 1 9.5v-3Z"/>
                                <path d="M2.5 9a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5Zm10 0a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5ZM4.5 3.5 3.2 5h9.6l-1.3-1.5a.5.5 0 0 0-.38-.175H4.88a.5.5 0 0 0-.38.175ZM3.7 4.5 5.1 2.85A1.5 1.5 0 0 1 6.24 2.5h3.52a1.5 1.5 0 0 1 1.14.35L12.3 4.5"/>
                            </svg>
                        </div>
                        {% endif %}
                        <span class="badge bg-success position-absolute top-0 end-0 m-3 px-3 py-2 shadow">
                            <i class="bi bi-broadcast me-1"></i>LIVE
                        </span>
                    </div>

                    <!-- Body -->
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title fw-bold mb-1">{{ v.title }}</h5>
                        <p class="card-text text-body-secondary small mb-3">
                            {{ v.description[:100] }}{% if v.description and v.description|length > 100 %}…{% endif %}
                        </p>

                        <!-- Price row -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <small class="text-body-secondary d-block">Starting Price</small>
                                <span class="text-body-secondary">${{ "{:,.2f}".format(v.starting_price) }}</span>
                            </div>
                            <div class="text-end">
                                <small class="text-success d-block fw-semibold">Current Bid</small>
                                <span class="fs-5 fw-bold text-success" id="price-{{ v.id }}">
                                    ${{ "{:,.2f}".format(v.current_price) }}
                                </span>
                            </div>
                        </div>

                        <!-- Countdown -->
                        <div class="d-flex align-items-center mb-3">
                            <i class="bi bi-clock text-warning me-2"></i>
                            <small class="countdown text-warning fw-semibold"
                                   data-end="{{ v.auction_end.isoformat() }}">
                                Calculating…
                            </small>
                        </div>

                        <!-- Bid button -->
                        <div class="mt-auto">
                            {% if user and not user.is_admin %}
                            <button class="btn btn-primary w-100 bid-btn"
                                    data-vehicle-id="{{ v.id }}"
                                    data-current-price="{{ v.current_price }}"
                                    data-title="{{ v.title }}">
                                <i class="bi bi-hammer me-1"></i>Place Bid
                            </button>
                            {% elif user and user.is_admin %}
                            <button class="btn btn-secondary w-100" disabled>
                                <i class="bi bi-shield-lock me-1"></i>Admins Cannot Bid
                            </button>
                            {% else %}
                            <a href="/login" class="btn btn-outline-primary w-100">
                                <i class="bi bi-box-arrow-in-right me-1"></i>Login to Bid
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        {% if not vehicles %}
        <div class="text-center py-5" id="emptyState">
            <i class="bi bi-inbox display-1 text-body-secondary"></i>
            <h4 class="mt-3 text-body-secondary">No active auctions right now</h4>
            <p class="text-body-secondary">Check back later for new listings.</p>
        </div>
        {% endif %}
    </div>
</section>

<!-- ── Bid Modal ──────────────────────────── -->
<div class="modal fade" id="bidModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-hammer me-2"></i>Place Your Bid
                </h5>
                <button type="button" class="btn-close btn-close-white"
                        data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <h6 class="fw-bold mb-3" id="modalVehicleTitle"></h6>
                <p class="mb-2">
                    Current price:
                    <strong class="text-success" id="modalCurrentPrice"></strong>
                </p>
                <div class="mb-3">
                    <label for="bidAmount" class="form-label">Your Bid ($)</label>
                    <input type="number" class="form-control form-control-lg"
                           id="bidAmount" step="100" min="0"
                           placeholder="Enter bid amount" />
                </div>
                <div id="bidAlert" class="d-none"></div>
            </div>
            <div class="modal-footer border-0">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-primary px-4" id="confirmBid">
                    <i class="bi bi-check-lg me-1"></i>Confirm Bid
                </button>
            </div>
        </div>
    </div>
</div>

<!-- SVG placeholder template for JS-injected cards -->
<template id="placeholderSvg">
    <div class="card-img-top vehicle-img d-flex align-items-center justify-content-center bg-body-secondary">
        <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" fill="currentColor"
             class="text-body-tertiary" viewBox="0 0 16 16">
            <path d="M2.5 6a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h11a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-11ZM1 6.5A1.5 1.5 0 0 1 2.5 5h11A1.5 1.5 0 0 1 15 6.5v3A1.5 1.5 0 0 1 13.5 11h-11A1.5 1.5 0 0 1 1 9.5v-3Z"/>
            <path d="M2.5 9a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5Zm10 0a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5ZM4.5 3.5 3.2 5h9.6l-1.3-1.5a.5.5 0 0 0-.38-.175H4.88a.5.5 0 0 0-.38.175ZM3.7 4.5 5.1 2.85A1.5 1.5 0 0 1 6.24 2.5h3.52a1.5 1.5 0 0 1 1.14.35L12.3 4.5"/>
        </svg>
    </div>
</template>
{% endblock %}

{% block scripts %}
<!-- Pass user role to JS -->
<script>
    const USER_IS_ADMIN = {{ 'true' if user and user.is_admin else 'false' }};
    const USER_LOGGED_IN = {{ 'true' if user else 'false' }};
</script>
<script src="/static/js/auction.js"></script>
{% endblock %}
